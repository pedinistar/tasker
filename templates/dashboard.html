{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Dashboard</h1>

    <!-- Add Task Button -->
    <div class="text-center mb-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">Add Task</button>
        <!-- Logout Button -->
        <form method="POST" action="{{ url_for('logout') }}">
            <button type="submit" class="btn btn-dark">Log out</button>
        </form>
    </div>

    <!-- Tasks List -->
    <div id="tasks-container">
        {% for task in tasks %}
        <div class="card mb-3 rounded-0" onclick="showTaskDetails({{ task.id }})">
            <div class="card-body d-flex justify-content-between align-items-center">
                <!-- Checkbox for marking completion -->
                <div class="form-check me-3">
                    <input class="form-check-input round-checkbox rounded-0" type="checkbox" id="complete-{{ task.id }}"
                        onclick="event.stopPropagation();" {% if task.is_completed %} checked {% endif %}
                        onchange="toggleTaskCompletion({{ task.id }})">
                </div>
                <div class="flex-grow-1">
                    <h5 class="card-title {{ 'text-decoration-line-through' if task.is_completed }}">{{ task.title }}
                    </h5>
                    <p class="card-text">{{ task.description }}</p>
                </div>
                <div class="d-flex align-items-center">
                    <!-- Edit Button -->
                    <button class="btn me-2 btn-style1" data-bs-toggle="modal"
                        data-bs-target="#editTaskModal-{{ task.id }}" onclick="event.stopPropagation();">Edit</button>
                    <!-- Delete Button -->
                    <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}"
                        onsubmit="return showDeleteModal(event, '{{ task.id }}');">
                        <button type="submit" class="btn btn-danger rounded-0"
                            onclick="event.stopPropagation();">Delete</button>
                    </form>
                </div>
            </div>
        </div>



        <!-- Edit Task Modal -->
        <div class="modal fade" id="editTaskModal-{{ task.id }}" tabindex="-1"
            aria-labelledby="editTaskModalLabel-{{ task.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTaskModalLabel-{{ task.id }}">Edit Task</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" action="{{ url_for('edit_task', task_id=task.id) }}">
                            {{ form.hidden_tag() }}
                            <div class="mb-3">
                                <label class="form-label" for="title-{{ task.id }}">Title</label>
                                <input type="text" id="title-{{ task.id }}" name="title" class="form-control"
                                    value="{{ task.title }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="description-{{ task.id }}">Description</label>
                                <textarea id="description-{{ task.id }}" name="description"
                                    class="form-control">{{ task.description }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="category-{{ task.id }}">Category</label>
                                <select id="category-{{ task.id }}" name="category" class="form-select">
                                    <option value="Work" {% if task.category=='Work' %}selected{% endif %}>Work</option>
                                    <option value="Personal" {% if task.category=='Personal' %}selected{% endif %}>
                                        Personal</option>
                                    <!-- Add other categories as needed -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="priority-{{ task.id }}">Priority</label>
                                <select id="priority-{{ task.id }}" name="priority" class="form-select">
                                    <option value="Low" {% if task.priority=='Low' %}selected{% endif %}>Low</option>
                                    <option value="Medium" {% if task.priority=='Medium' %}selected{% endif %}>Medium
                                    </option>
                                    <option value="High" {% if task.priority=='High' %}selected{% endif %}>High</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="deadline-{{ task.id }}">Deadline</label>
                                <input type="date" id="deadline-{{ task.id }}" name="deadline" class="form-control"
                                    value="{{ task.deadline }}">
                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% endfor %}
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('dashboard') }}">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.title.label(class='form-label') }}
                            {{ form.title(class='form-control') }}
                        </div>
                        <div class="mb-3">
                            {{ form.description.label(class='form-label') }}
                            {{ form.description(class='form-control') }}
                        </div>
                        <div class="mb-3">
                            {{ form.category.label(class='form-label') }}
                            {{ form.category(class='form-select') }}
                        </div>
                        <div class="mb-3">
                            {{ form.priority.label(class='form-label') }}
                            {{ form.priority(class='form-select') }}
                        </div>
                        <div class="mb-3">
                            {{ form.deadline.label(class='form-label') }}
                            {{ form.deadline(class='form-control') }}
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">Save Task</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskDetailsModalLabel">Task Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title" id="taskTitle"></h5>
                            <p class="card-text" id="taskDescription"></p>
                            <p><strong>Category:</strong> <span id="taskCategory"></span></p>
                            <p><strong>Priority:</strong> <span id="taskPriority"></span></p>
                            <p><strong>Deadline:</strong> <span id="taskDeadline"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this task?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmDeleteButton" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    let deleteForm = null;

    function showDeleteModal(event, taskId) {
        event.preventDefault(); // Prevent the default form submission
        deleteForm = event.target; // Save the form that will be submitted

        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
        deleteModal.show();

        // Add click event listener to the confirm delete button
        document.getElementById('confirmDeleteButton').addEventListener('click', function () {
            if (deleteForm) {
                deleteForm.submit(); // Submit the form
            }
        });
    }

    function showTaskDetails(taskId) {
        fetch(`/task-details/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Populate the modal with task details
                    document.getElementById('taskTitle').innerText = data.title;
                    document.getElementById('taskDescription').innerText = data.description;
                    document.getElementById('taskCategory').innerText = data.category;
                    document.getElementById('taskPriority').innerText = data.priority;
                    document.getElementById('taskDeadline').innerText = data.deadline;

                    // Show the modal
                    const taskDetailsModal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
                    taskDetailsModal.show();
                }
            })
            .catch(error => console.error('Error fetching task details:', error));
    }

    function toggleTaskCompletion(taskId) {
        const checkbox = document.getElementById(`complete-${taskId}`);
        fetch(`/toggle-task-completion/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ form.csrf_token._value() }}'
            }
        }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the task appearance based on the completion status
                    const cardTitle = checkbox.closest('.card-body').querySelector('.card-title');
                    if (checkbox.checked) {
                        cardTitle.classList.add('text-decoration-line-through');
                    } else {
                        cardTitle.classList.remove('text-decoration-line-through');
                    }
                }
            })
            .catch(error => console.error('Error toggling task completion:', error));
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}